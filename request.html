<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergency Request System</title>

  <!-- Firebase + Leaflet -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWt99TXD-yWrlDuU6TPEZVMPrDQGV3Y-w",
      authDomain: "emergency-response-927b4.firebaseapp.com",
      projectId: "emergency-response-927b4",
      storageBucket: "emergency-response-927b4.appspot.com",
      messagingSenderId: "764143976759",
      appId: "1:764143976759:web:340b2fa2834b6406439ab2",
      measurementId: "G-Z0479KDD64",
      databaseURL: "https://emergency-response-927b4-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    function populateMunicipalities(locations) {
      const municipalitySelect = document.getElementById("municipality");
      const barangaySelect = document.getElementById("barangay");
      municipalitySelect.innerHTML = '<option value="">-- Select municipality --</option>';
      Object.keys(locations).forEach(m => {
        const option = document.createElement("option");
        option.value = m;
        option.textContent = m;
        municipalitySelect.appendChild(option);
      });
      barangaySelect.innerHTML = '<option value="">-- Select barangay --</option>';
      barangaySelect.disabled = true;

      municipalitySelect.addEventListener("change", () => {
        const selectedMun = municipalitySelect.value;
        barangaySelect.innerHTML = "";
        if (!selectedMun) {
          barangaySelect.disabled = true;
          barangaySelect.innerHTML = '<option value="">-- Select municipality first --</option>';
          return;
        }
        (locations[selectedMun] || []).forEach(b => {
          const option = document.createElement("option");
          option.value = b;
          option.textContent = b;
          barangaySelect.appendChild(option);
        });
        barangaySelect.disabled = false;
      });
    }

    async function loadCebuMap() {
      try {
        const res = await fetch(
          "https://raw.githubusercontent.com/flores-jacob/philippine-regions-provinces-cities-municipalities-barangays/master/philippine_provinces_cities_municipalities_and_barangays_2019v2.json"
        );
        const allData = await res.json();
        let cebuData = null;
        for (const regionKey in allData) {
          const region = allData[regionKey];
          if (!region.province_list) continue;
          if (region.province_list["CEBU"]) {
            cebuData = region.province_list["CEBU"];
            break;
          }
        }
        const locations = {};
        if (cebuData.municipality_list) {
          for (const mun in cebuData.municipality_list) {
            locations[mun] = cebuData.municipality_list[mun].barangay_list || [];
          }
        }
        if (cebuData.city_list) {
          for (const city in cebuData.city_list) {
            locations[city] = cebuData.city_list[city].barangay_list || [];
          }
        }
        populateMunicipalities(locations);
        return locations;
      } catch (err) {
        console.error("Failed to load Cebu map:", err);
      }
    }

    function reverseGeocode(lat, lng, locations) {
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
        .then(res => res.json())
        .then(data => {
          const address = data.address || {};
          let municipality = address.city || address.town || address.village || "";
          let barangay = address.suburb || address.neighbourhood || address.hamlet || "";

          if (municipality in locations) {
            document.getElementById("municipality").value = municipality;
            const barangaySelect = document.getElementById("barangay");
            barangaySelect.innerHTML = "";
            if (locations[municipality].includes(barangay)) {
              const option = document.createElement("option");
              option.value = barangay;
              option.textContent = barangay;
              barangaySelect.appendChild(option);
              barangaySelect.disabled = false;
            } else {
              barangaySelect.disabled = false;
              barangaySelect.innerHTML = '<option value="">-- Select barangay --</option>';
            }
          }
        })
        .catch(err => console.error("Reverse geocoding failed:", err));
    }

    // Convert image file to base64
    function convertToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const locations = await loadCebuMap();
      const map = L.map('landmarkMap').setView([10.3157, 123.8854], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      let marker = null;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          map.setView([lat, lng], 15);
          marker = L.marker([lat, lng]).addTo(map);
          marker.bindPopup("Your location").openPopup();
          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lng;
          document.getElementById("landmark").value = `${lat}, ${lng}`;
          reverseGeocode(lat, lng, locations);
        });
      }

      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`Selected location<br><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">View in Google Maps</a>`).openPopup();
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        document.getElementById("landmark").value = `${lat}, ${lng}`;
        reverseGeocode(lat, lng, locations);
      });

      // Handle image preview
      const photoInput = document.getElementById("photo");
      const photoPreview = document.getElementById("photoPreview");
      photoInput.addEventListener("change", () => {
        const file = photoInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            photoPreview.src = e.target.result;
            photoPreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          photoPreview.style.display = "none";
        }
      });

      const form = document.getElementById("requestForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = form.querySelector("button");
        submitBtn.disabled = true;

        const requestor = document.getElementById("requestor").value;
        const municipality = document.getElementById("municipality").value;
        const barangay = document.getElementById("barangay").value;
        const landmark = document.getElementById("landmark").value;
        const status = document.getElementById("status").value;
        const contact = document.getElementById("contact").value;
        const latitude = document.getElementById("latitude").value;
        const longitude = document.getElementById("longitude").value;
        const photoFile = document.getElementById("photo").files[0];

        if (!requestor || !municipality || !barangay || !landmark || !status || !contact || !latitude || !longitude) {
          alert("Please fill all fields and select a location.");
          submitBtn.disabled = false;
          return;
        }

        let photoBase64 = "";
        if (photoFile) {
          try {
            photoBase64 = await convertToBase64(photoFile);
          } catch (err) {
            console.error("Error converting photo:", err);
          }
        }

        try {
          const date = new Date().toISOString().split('T')[0];
          await push(ref(db, "emergency_requests"), {
            requestor, municipality, barangay, landmark, status, contact,
            latitude, longitude, date, photo: photoBase64
          });
          alert("Emergency request submitted successfully!");
          form.reset();
          photoPreview.style.display = "none";
          document.getElementById("barangay").disabled = true;
          if (marker) map.removeLayer(marker);
        } catch (err) {
          alert("Failed to submit request.");
          console.error(err);
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
  </script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fefefe; color:#333; }
    header {
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)),
                  url('https://images.unsplash.com/photo-1586281380394-1dfd2e5bfffc?auto=format&fit=crop&w=1200&q=80') center/cover no-repeat;
      color:white; text-align:center; padding:60px 20px;
    }
    header h1 { font-size:2rem; margin-bottom:10px; }
    header p { font-size:1rem; margin-bottom:15px; }
    section { padding:20px; max-width:800px; margin:auto; }
    .card { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    input, textarea, select { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:5px; }
    button { background:#e74c3c; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; width:100%; }
    button:hover { background:#c0392b; }
    #landmarkMap { height:250px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; }
    #photoPreview { display:none; margin-top:10px; width:100%; max-height:250px; border-radius:5px; object-fit:cover; border:1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <h1>Emergency Request System</h1>
    <p>Send immediate assistance requests with location data</p>
  </header>

  <section>
    <div class="card">
      <h2>Submit Emergency Request</h2>
      <form id="requestForm">
        <label for="requestor">Requestor:</label>
        <input type="text" id="requestor" required>

        <label for="municipality">Municipality:</label>
        <select id="municipality" required>
          <option value="">-- Loading municipalities --</option>
        </select>

        <label for="barangay">Barangay:</label>
        <select id="barangay" disabled>
          <option value="">-- Select municipality first --</option>
        </select>

        <label for="landmark">Closest Landmark:</label>
        <input type="text" id="landmark" required>

        <label for="landmarkMap">Select Location on Map:</label>
        <div id="landmarkMap"></div>

        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">

        <label for="status">Status:</label>
        <input type="text" id="status" placeholder="e.g., injured, trapped, needs rescue" required>

        <label for="contact">Contact Number:</label>
        <input type="tel" id="contact" placeholder="09xxxxxxxxx" required>

        <!-- Added for photo upload -->
        <label for="photo">Add Photo (optional):</label>
        <input type="file" id="photo" accept="image/*">
        <img id="photoPreview" alt="Preview of uploaded photo">

        <button type="submit">Submit Request</button>
      </form>
    </div>
  </section>
</body>
</html>

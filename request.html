<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergency Request System</title>

  <!-- Firebase + Leaflet -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBWt99TXD-yWrlDuU6TPEZVMPrDQGV3Y-w",
      authDomain: "emergency-response-927b4.firebaseapp.com",
      projectId: "emergency-response-927b4",
      storageBucket: "emergency-response-927b4.appspot.com",
      messagingSenderId: "764143976759",
      appId: "1:764143976759:web:340b2fa2834b6406439ab2",
      measurementId: "G-Z0479KDD64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const requestsCol = collection(db, "emergency_requests");

    // Reverse geocode: returns a human readable address and sets address field.
    const addressCache = new Map();
    async function reverseGeocode(lat, lng) {
      const nlat = Number(lat);
      const nlng = Number(lng);
      if (!isFinite(nlat) || !isFinite(nlng)) return `${lat}, ${lng}`;

      const key = `${nlat.toFixed(5)},${nlng.toFixed(5)}`;
      if (addressCache.has(key)) return addressCache.get(key);

      try {
        const url = `https://nominatim.openstreetmap.org/reverse?lat=${encodeURIComponent(nlat)}&lon=${encodeURIComponent(nlng)}&format=jsonv2`;
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        const display = data.display_name || `${nlat.toFixed(6)}, ${nlng.toFixed(6)}`;
        addressCache.set(key, display);
        // set UI if present
        const addressEl = document.getElementById("address");
        if (addressEl) addressEl.value = display;
        return display;
      } catch (err) {
        const fallback = `${nlat.toFixed(6)}, ${nlng.toFixed(6)}`;
        addressCache.set(key, fallback);
        const addressEl = document.getElementById("address");
        if (addressEl) addressEl.value = fallback;
        return fallback;
      }
    }

    // Convert image file to base64
    function convertToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    window.addEventListener("DOMContentLoaded", async () => {
      const map = L.map('landmarkMap').setView([10.3157, 123.8854], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      let marker = null;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = Number(pos.coords.latitude).toFixed(6);
          const lng = Number(pos.coords.longitude).toFixed(6);
          map.setView([lat, lng], 15);
          marker = L.marker([lat, lng]).addTo(map);
          marker.bindPopup("Your location").openPopup();
          document.getElementById("latitude").value = lat;
          document.getElementById("longitude").value = lng;
          document.getElementById("landmark").value = `${lat}, ${lng}`;
          reverseGeocode(lat, lng);
        }, (err) => {
          console.warn("Geolocation failed:", err);
        });
      }

      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`Selected location<br><a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">View in Google Maps</a>`).openPopup();
        document.getElementById("latitude").value = lat;
        document.getElementById("longitude").value = lng;
        document.getElementById("landmark").value = `${lat}, ${lng}`;
        reverseGeocode(lat, lng);
      });

      // Handle image preview
      const photoInput = document.getElementById("photo");
      const photoPreview = document.getElementById("photoPreview");
      if (photoInput) {
        photoInput.addEventListener("change", () => {
          const file = photoInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              photoPreview.src = e.target.result;
              photoPreview.style.display = "block";
            };
            reader.readAsDataURL(file);
          } else {
            photoPreview.style.display = "none";
          }
        });
      }

      const form = document.getElementById("requestForm");
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = form.querySelector("button[type='submit']");
        submitBtn.disabled = true;

        const requestor = document.getElementById("requestor").value.trim();
        const landmark = document.getElementById("landmark").value.trim(); // hidden input
        const status = document.getElementById("status").value.trim();
        const contact = document.getElementById("contact").value.trim();
        const latitude = document.getElementById("latitude").value.trim();
        const longitude = document.getElementById("longitude").value.trim();
        let address = document.getElementById("address").value.trim();
        const photoFile = document.getElementById("photo").files[0];

        if (!requestor || !status || !contact || !latitude || !longitude) {
          alert("Please fill all required fields and select a location.");
          submitBtn.disabled = false;
          return;
        }

        if (!address && latitude && longitude) {
          address = await reverseGeocode(latitude, longitude);
        }

        let photoBase64 = "";
        if (photoFile) {
          try {
            photoBase64 = await convertToBase64(photoFile);
          } catch (err) {
            console.error("Error converting photo:", err);
          }
        }

        try {
          const isoDate = new Date().toISOString();
          const payload = {
            requestor,
            // landmark is hidden — kept for compatibility but optional
            landmark: landmark || "",
            address: address || "",
            status,
            contact,
            latitude,
            longitude,
            date: isoDate,
            photo: photoBase64
          };

          // Save to Firestore
          await addDoc(requestsCol, payload);

          alert("Emergency request submitted successfully!");
          form.reset();
          photoPreview.style.display = "none";
          if (marker) map.removeLayer(marker);
          document.getElementById("latitude").value = "";
          document.getElementById("longitude").value = "";
          document.getElementById("address").value = "";
        } catch (err) {
          console.error("Failed to save request:", err);
          alert("Failed to submit request.");
        } finally {
          submitBtn.disabled = false;
        }
      });
    });
  </script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#fefefe; color:#333; }
    header { background:#222;color:white;text-align:center;padding:24px 12px }
    section { padding:20px; max-width:800px; margin:auto; }
    .card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    input, textarea, select { width:100%; padding:10px; margin:8px 0; border:1px solid #ccc; border-radius:5px; }
    button { background:#e74c3c; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; width:100%; }
    #landmarkMap { height:250px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; }
    #photoPreview { display:none; margin-top:10px; width:100%; max-height:250px; border-radius:5px; object-fit:cover; border:1px solid #ccc; }
  </style>
</head>
<body>
  <header>
    <h1>Emergency Request System</h1>
    <p>Send immediate assistance requests with location data</p>
  </header>

  <section>
    <div class="card">
      <h2>Submit Emergency Request</h2>
      <form id="requestForm">
        <label for="requestor">Requestor:</label>
        <input type="text" id="requestor" required>

        <!-- landmark hidden (populated by map click) -->
        <input type="hidden" id="landmark">

        <label for="address">Resolved Address:</label>
        <input type="text" id="address" readonly placeholder="Address will appear after selecting location">

        <label for="landmarkMap">Select Location on Map:</label>
        <div id="landmarkMap"></div>

        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">

        <label for="status">Status:</label>
        <input type="text" id="status" placeholder="e.g., injured, trapped, needs rescue" required>

        <label for="contact">Contact Number:</label>
        <input type="tel" id="contact" placeholder="09xxxxxxxxx" required>

        <label for="photo">Add Photo (optional):</label>
        <input type="file" id="photo" accept="image/*">
        <img id="photoPreview" alt="Preview of uploaded photo">

        <button type="submit">Submit Request</button>
      </form>
    </div>
  </section>
</body>
</html>
